typeof Craft.Formie>"u"&&(Craft.Formie={});Craft.Formie.SubmissionIndex=Craft.BaseElementIndex.extend({editableForms:null,$newSubmissionBtnGroup:null,$newSubmissionBtn:null,startDate:null,endDate:null,init(e,t,i){this.on("selectSource",$.proxy(this,"updateButton")),this.on("selectSite",$.proxy(this,"updateButton")),i.criteria={isIncomplete:null,isSpam:null},t.find(".main");var n=t.find("#toolbar:first"),s=n.find(".statusmenubtn:first"),a=s.menubtn().data("menubtn");if(a){var l=$('<li><a data-incomplete><span class="icon" data-icon="draft"></span> '+Craft.t("formie","Incomplete")+"</a></li>"),o=$('<li><a data-spam><span class="icon" data-icon="error"></span> '+Craft.t("formie","Spam")+"</a></li>"),d=$('<hr class="padded">');a.menu.addOptions(l.children()),a.menu.addOptions(o.children()),d.appendTo(a.menu.$container.find("ul:first")),l.appendTo(a.menu.$container.find("ul:first")),o.appendTo(a.menu.$container.find("ul:first")),a.menu.on("optionselect",$.proxy(this,"_handleStatusChange"))}Craft.ui.createDateRangePicker({onChange:(function(h,f){this.startDate=h,this.endDate=f,this.updateElements()}).bind(this)}).appendTo(n),this.base(e,t,i)},afterInit(){this.editableForms=[];var{editableSubmissions:e}=Craft.Formie;if(e)for(var t=0;t<e.length;t++){var i=e[t];this.getSourceByKey("form:"+i.id)&&this.editableForms.push(i)}this.base()},_handleStatusChange(e){this.statusMenu.$options.removeClass("sel");var t=$(e.selectedOption).addClass("sel");this.$statusMenuBtn.html(t.html()),this.trashed=!1,this.drafts=null,this.status=null,this.settings.criteria.isIncomplete=null,this.settings.criteria.isSpam=null;let i=null;Garnish.hasAttr(t,"data-spam")?(this.settings.criteria.isSpam=!0,i="spam"):Garnish.hasAttr(t,"data-incomplete")?(this.settings.criteria.isIncomplete=!0,i="incomplete"):Garnish.hasAttr(t,"data-trashed")?(this.trashed=!0,this.settings.criteria.isIncomplete=null,this.settings.criteria.isSpam=null,i="trashed"):Garnish.hasAttr(t,"data-drafts")?(this.drafts=!0,i="drafts"):this.status=t.data("status"),this.activeViewMenu&&this.activeViewMenu.updateSortField(),Craft.setQueryParam("status",i),this.updateElements()},getViewClass(e){return e==="table"?Craft.Formie.SubmissionTableView:this.base(e)},getDefaultSort(){return["dateCreated","desc"]},getDefaultSourceKey(){if(this.settings.context==="index"&&typeof defaultFormieFormHandle<"u")for(var e=0;e<this.$sources.length;e++){var t=$(this.$sources[e]);if(t.data("handle")===defaultFormieFormHandle)return t.data("key")}return this.base()},updateButton(){if(this.$source){var e=this.$source.data("handle"),t,i,n;if(this.editableForms.length){this.$newSubmissionBtnGroup&&this.$newSubmissionBtnGroup.remove();var s;if(e){for(t=0;t<this.editableForms.length;t++)if(this.editableForms[t].handle===e){s=this.editableForms[t];break}}this.$newSubmissionBtnGroup=$('<div class="btngroup submit"/>');var a;if(s?(i=this._getFormTriggerHref(s),n=this.settings.context==="index"?Craft.t("formie","New submission"):Craft.t("formie","New {form} submission",{form:s.name}),this.$newSubmissionBtn=$('<a class="btn submit add icon" '+i+' role="button" tabindex="0">'+Craft.escapeHtml(n)+"</a>").appendTo(this.$newSubmissionBtnGroup),this.settings.context!=="index"&&this.addListener(this.$newSubmissionBtn,"click",function(f){this._openCreateSubmissionModal(f.currentTarget.getAttribute("data-id"))}),this.editableForms.length>1&&(a=$("<button/>",{type:"button",class:"btn submit menubtn"}).appendTo(this.$newSubmissionBtnGroup))):this.$newSubmissionBtn=a=$("<button/>",{type:"button",class:"btn submit add icon menubtn",text:Craft.t("formie","New submission")}).appendTo(this.$newSubmissionBtnGroup),a){var l='<div class="menu"><ul>';for(t=0;t<this.editableForms.length;t++){var o=this.editableForms[t];(this.settings.context==="index"&&$.inArray(this.siteId,o.sites)!==-1||this.settings.context!=="index"&&o!==s)&&(i=this._getFormTriggerHref(o),n=this.settings.context==="index"?o.name:Craft.t("formie","New {form} submission",{form:o.name}),l+="<li><a "+i+">"+Craft.escapeHtml(n)+"</a></li>")}l+="</ul></div>",$(l).appendTo(this.$newSubmissionBtnGroup);var d=new Garnish.MenuBtn(a);this.settings.context!=="index"&&d.on("optionSelect",f=>{this._openCreateSubmissionModal(f.option.getAttribute("data-id"))})}this.addButton(this.$newSubmissionBtnGroup)}if(this.settings.context==="index"&&typeof history<"u"){var h="formie/submissions";e&&(h+="/"+e),history.replaceState({},"",Craft.getUrl(h))}}},getViewParams:function(){var e=this.base();if(this.startDate||this.endDate){var t=this.$source.data("date-attr")||"dateCreated";e.criteria[t]=["and"],this.startDate&&e.criteria[t].push(">="+this.startDate.getTime()/1e3),this.endDate&&e.criteria[t].push("<"+(this.endDate.getTime()/1e3+86400))}return e},getSite(){if(this.siteId)return Craft.sites.find(e=>e.id==this.siteId)},_getFormTriggerHref(e){if(this.settings.context==="index"){const t=`formie/submissions/${e.handle}/new`,i=this.getSite(),n=i?{site:i.handle}:void 0;return`href="${Craft.getUrl(t,n)}"`}return`data-id="${e.id}"`},_openCreateSubmissionModal(e){if(!this.$newSubmissionBtn.hasClass("loading")){for(var t,i=0;i<this.editableForms.length;i++)if(this.editableForms[i].id==e){t=this.editableForms[i];break}if(t){this.$newSubmissionBtn.addClass("inactive");var n=this.$newSubmissionBtn.text();this.$newSubmissionBtn.text(Craft.t("formie","New {form} submission",{form:t.name})),Craft.createElementEditor(this.elementType,{hudTrigger:this.$newSubmissionBtnGroup,siteId:this.siteId,attributes:{formId:e},onHideHud:()=>{this.$newSubmissionBtn.removeClass("inactive").text(n)},onSaveElement:s=>{var a="form:"+t.id;this.sourceKey!==a&&this.selectSourceByKey(a),this.selectElementAfterUpdate(s.id),this.updateElements()}})}}}});Craft.Formie.SubmissionTableView=Craft.TableElementIndexView.extend({afterInit(){this.$explorerContainer=$('<div class="chart-explorer-container"></div>').prependTo(this.$container),this.$chartExplorer=$('<div class="chart-explorer"></div>').appendTo(this.$explorerContainer),this.$chartContainer=$('<div class="chart-container"></div>').appendTo(this.$chartExplorer),this.$chart=$('<div class="chart"></div>').appendTo(this.$chartContainer),this.loadReport(),this.base()},groupAndFillData(e){const t=Object.entries(e),i=new Date(t[0][0]),n=new Date(t[t.length-1][0]),s=(i-n)/(1e3*60*60*24);let a;s>=730?a="year":s>=60?a="month":s>=2?a="day":a="hour";const l=f=>{var r=new Date(f.getTime());return a==="year"?(r.setMonth(0),r.setDate(1),r.setHours(0),r.setMinutes(0),r.setSeconds(0)):a==="month"?(r.setDate(1),r.setHours(0),r.setMinutes(0),r.setSeconds(0)):a==="day"?(r.setHours(0),r.setMinutes(0),r.setSeconds(0)):a==="hour"&&(r.setMinutes(0),r.setSeconds(0)),a==="hour"?r.toISOString().slice(0,19).replace("T"," "):r.toISOString().split("T")[0]},o={};let d=new Date(n);for(;d<=i||Object.keys(o).length<2;){const f=l(d);o[f]=0,a==="year"?d.setFullYear(d.getFullYear()+1):a==="month"?d.setMonth(d.getMonth()+1):a==="day"?d.setDate(d.getDate()+1):d.setHours(d.getHours()+1)}for(const[f,r]of t){var h=l(new Date(f));h in o&&(o[h]+=r)}return{data:Object.entries(o).map(([f,r])=>[f,r]),group:a}},loadReport(){const e=$(this.elementIndex.$elements).find(".element");if(!e.length){this.$explorerContainer.addClass("chart-empty");return}this.chart||(this.chart=new Craft.charts.Area(this.$chart));let t={};e.each(function(o,d){let h=$(d).data("date-created");t[h]||(t[h]=0),t[h]++});const i=this.groupAndFillData(t);var s={columns:[{type:i.group==="hour"?"datetime":"date",label:"Date"},{type:"number",label:"Submissions"}],rows:i.data},a=new Craft.charts.DataTable(s),l={orientation:Craft.orientation,formats:{numberFormat:",.0f"},dataScale:i.group};this.chart.draw(a,l)}});(function(e){e(document).on("click",".js-fui-submission-modal-send-btn",function(t){t.preventDefault(),new Craft.Formie.SendNotificationModal(e(this).data("id"))})})(jQuery);Craft.Formie.SendNotificationModal=Garnish.Modal.extend({init(e){this.$form=$('<form class="modal fui-send-notification-modal" method="post" accept-charset="UTF-8"/>').appendTo(Garnish.$bod),this.$body=$('<div class="body"><div class="spinner big"></div></div>').appendTo(this.$form);var t=$('<div class="footer"/>').appendTo(this.$form),i=$('<div class="buttons right"/>').appendTo(t);this.$cancelBtn=$('<input type="button" class="btn" value="'+Craft.t("formie","Cancel")+'"/>').appendTo(i),this.$updateBtn=$('<input type="submit" class="btn submit" value="'+Craft.t("formie","Send Email Notification")+'"/>').appendTo(i),this.$footerSpinner=$('<div class="spinner right hidden"/>').appendTo(t),Craft.initUiElements(this.$form),this.addListener(this.$cancelBtn,"click","onFadeOut"),this.addListener(this.$updateBtn,"click","onSend"),this.base(this.$form);var n={id:e};Craft.sendActionRequest("POST","formie/submissions/get-send-notification-modal-content",{data:n}).then(s=>{this.$body.html(s.data.modalHtml),Craft.appendHeadHtml(s.data.headHtml),Craft.appendBodyHtml(s.data.footHtml)})},onFadeOut(){this.$form.remove(),this.$shade.remove()},onSend(e){e.preventDefault(),this.$footerSpinner.removeClass("hidden");var t=this.$form.serialize();Craft.sendActionRequest("POST","formie/submissions/send-notification",{data:t}).then(i=>{location.reload()}).catch(({response:i})=>{i&&i.data&&i.data.message?Craft.cp.displayError(i.data.message):Craft.cp.displayError()}).finally(()=>{this.$footerSpinner.addClass("hidden")})}});Craft.registerElementIndexClass("verbb\\formie\\elements\\Submission",Craft.Formie.SubmissionIndex);typeof Craft.Formie>"u"&&(Craft.Formie={});(function(e){e(document).on("click",".js-fui-notification-modal-resend-btn",function(t){t.preventDefault(),new Craft.Formie.ResendNotificationModal(e(this).data("id"))})})(jQuery);Craft.Formie.ResendNotificationModal=Garnish.Modal.extend({init(e){this.$form=$('<form class="modal fui-resend-modal" method="post" accept-charset="UTF-8"/>').appendTo(Garnish.$bod),this.$body=$('<div class="body"><div class="spinner big"></div></div>').appendTo(this.$form);var t=$('<div class="footer"/>').appendTo(this.$form),i=$('<div class="buttons right"/>').appendTo(t);this.$cancelBtn=$('<input type="button" class="btn" value="'+Craft.t("formie","Cancel")+'"/>').appendTo(i),this.$updateBtn=$('<input type="submit" class="btn submit" value="'+Craft.t("formie","Resend Email Notification")+'"/>').appendTo(i),this.$footerSpinner=$('<div class="spinner right hidden"/>').appendTo(t),Craft.initUiElements(this.$form),this.addListener(this.$cancelBtn,"click","onFadeOut"),this.addListener(this.$updateBtn,"click","onResend"),this.base(this.$form);var n={id:e};Craft.sendActionRequest("POST","formie/sent-notifications/get-resend-modal-content",{data:n}).then(s=>{this.$body.html(s.data.modalHtml),Craft.appendHeadHtml(s.data.headHtml),Craft.appendBodyHtml(s.data.footHtml)})},onFadeOut(){this.$form.remove(),this.$shade.remove()},onResend(e){e.preventDefault(),this.$footerSpinner.removeClass("hidden");var t=this.$form.serialize();Craft.sendActionRequest("POST","formie/sent-notifications/resend",{data:t}).then(i=>{location.reload()}).catch(({response:i})=>{i&&i.data&&i.data.message?Craft.cp.displayError(i.data.message):Craft.cp.displayError()}).finally(()=>{this.$footerSpinner.addClass("hidden")})}});Craft.Formie.BulkResendElementAction=Garnish.Base.extend({init(e){new Craft.ElementActionTrigger({type:e,batch:!0,activate(t){new Craft.Formie.BulkResendModal(t.find(".element"),t)}})}});Craft.Formie.BulkResendModal=Garnish.Modal.extend({init(e,t){this.$element=e,this.$selectedItems=t;var i=t.length==1?"":"s",n="<strong>"+t.length+"</strong> notification"+i;this.$form=$('<form class="modal fitted" method="post" accept-charset="UTF-8"/>').appendTo(Garnish.$bod),this.$body=$('<div class="body" style="max-width: 560px;"><h2>'+Craft.t("formie","Bulk Resend Email Notification")+"</h2><p>"+Craft.t("formie","You are about to resend {desc}. You can resend each notification to their original recipients, or choose specific recipients.",{desc:n})+"</p></div>").appendTo(this.$form);var s=Craft.ui.createSelectField({label:Craft.t("formie","Recipients"),name:"recipientsType",options:[{label:Craft.t("formie","Original Recipients"),value:"original"},{label:Craft.t("formie","Custom Recipients"),value:"custom"}],toggle:!0,targetPrefix:"type-"}).appendTo(this.$body),a=$("<div/>",{id:"type-custom",class:"hidden"}).appendTo(this.$body);Craft.ui.createTextField({label:Craft.t("formie","Custom Recipients"),instructions:Craft.t("formie","Provide recipients for each email notification to be sent to. For multiple recipients, separate each with a comma."),name:"to",required:!0}).appendTo(a),this.$selectedItems.each((d,h)=>{$("<input/>",{type:"hidden",name:"ids[]",value:$(h).data("id")}).appendTo(this.$body)});var l=$('<div class="footer"/>').appendTo(this.$form),o=$('<div class="buttons right"/>').appendTo(l);this.$cancelBtn=$('<input type="button" class="btn" value="'+Craft.t("formie","Cancel")+'"/>').appendTo(o),this.$updateBtn=$('<input type="submit" class="btn submit" value="'+Craft.t("formie","Resend Email Notifications")+'"/>').appendTo(o),this.$footerSpinner=$('<div class="spinner right hidden"/>').appendTo(l),this.addListener(this.$cancelBtn,"click","onFadeOut"),this.addListener(this.$updateBtn,"click","onResend"),this.addListener(s,"change","onSelectChange"),this.base(this.$form)},onSelectChange(){this.updateSizeAndPosition()},onFadeOut(){this.$form.remove(),this.$shade.remove()},onResend(e){e.preventDefault(),this.$footerSpinner.removeClass("hidden");var t=this.$form.serialize();Craft.sendActionRequest("POST","formie/sent-notifications/bulk-resend",{data:t}).then(i=>{location.reload()}).catch(({response:i})=>{i&&i.data&&i.data.message?Craft.cp.displayError(i.data.message):Craft.cp.displayError()}).finally(()=>{this.$footerSpinner.addClass("hidden")})}});typeof Craft.Formie>"u"&&(Craft.Formie={});jQuery;
//# sourceMappingURL=formie-cp.js.map
